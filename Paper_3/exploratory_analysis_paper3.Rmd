---
title: "Model extrapolation"
output:
  html_document:
    theme: journal
date: 'null'
---
#bar
```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(echo = TRUE,
                results = ('markup'))
```


## Exploratory analysis of US data and Argentinian data
```{r exploratory analysis, echo=FALSE}
# Purpose        : Fit a SEM model with Argentinian data and apply in KS data
# Maintainer     : Marcos Angelini  (angelini75@gmail.com); 


rm(list=ls()[ls()!="t"])
name <- function(x) { as.data.frame(names(x))}

Arg <- read.csv("~/Documents/SEM2DSM1/Paper_2/data/calib.data-5.0.csv")[,c(-1,-20)]

d <- read.csv("~/Documents/SEM2DSM1/Paper_3/data/KS.data-0.2.csv")[,c(-1)] 
name(d)
names(d)[5:10] <- c("CEC.A","CEC.B","CEC.C","OC.A","OC.B","OC.C")
# remove outlayers
# d <- d[d$idp!=26058,]
# d <- d[d$idp!=22961,]
d <- cbind(d[1],
           d[,colnames(Arg)[2:10]],
           d[11:21])
d <- d[c(-156,-157),]
ks <- d
name(ks)
name(Arg)
names(ks)[1] <- "id.p"
ks$evim <- ks$evim/10000
ks$evisd <- ks$evisd/10000
Arg <- Arg[,names(ks)]

ks$country <- "US"
Arg$country <- "Arg"
data <- rbind(ks, Arg)

library(reshape)
library(ggplot2)
meltp <- unique(melt(data,id.vars = c("id.p", "country")))
name(meltp)
sp <- levels(meltp$variable)
# plot soil properties
ggplot(data = meltp[which(meltp$variable %in% sp[1:9]),],
       aes(x = value, fill = country)) + geom_density(alpha = 0.4) +
  facet_wrap( ~ variable,scales = "free")
# plot covariates
ggplot(data = meltp[which(meltp$variable %in% sp[c(10:12,14,15,17:19)]),],
       aes(x = value, fill = country)) + geom_density(alpha = 0.4) +
  facet_wrap( ~ variable,scales = "free")
#############
# another approach from: http://ggobi.github.io/ggally/#ggallyggnostic
# Load required packages
require(GGally)

# hist and correlation for soil properties
ggscatmat(data, color = "country", columns = c(names(data)[c(2:10)]), alpha = 0.10) + 
  theme(axis.text.x = element_text(size = 8,angle = 90, vjust = 0.5),
        axis.text.y = element_text(size = 8,angle =  0, vjust = 0.5))
# hist and scaterplots for covariates
ggscatmat(data, color = "country", columns = c(names(data)[c(11:12,14,15,17:21)]), alpha = 0.10) + 
  theme(axis.text.x = element_text(size = 8,angle = 90, vjust = 0.5),
        axis.text.y = element_text(size = 8,angle =  0, vjust = 0.5))
```

## Accuracy measures from 7 models
```{r accuracy, echo=FALSE}
rm(list=ls())
name <- function(x) { as.data.frame(names(x))}
a <- read.csv("~/Documents/SEM2DSM1/Paper_3/data/accuracy2.csv")

library(ggplot2)
library(gridExtra)
library(ggthemes)
with(a, levels(hor))

a <- within(a, hor <- factor(hor, levels(a$hor)[c(1,3,4,2)]))
with(a, levels(hor))
a <- within(a, sp <- factor(sp, levels(a$sp)[c(1,3,2)]))
with(a, levels(sp))
a <- b
b <- a
a <- a[a$sp=="CEC",]
CEC.ME <- ggplot(a[a$variable=="ME",], aes(x = model, y = value, fill = value)) +
  geom_col( show.legend = F) + 
  facet_grid(hor ~ variable) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1), strip.text.y = element_blank()) +
  scale_fill_gradient2(low="#4885ed", mid = "#888888",  high="#db3236" ) + 
  scale_x_discrete(name="") + scale_y_continuous(name = "CEC", limits = c(-3.5,3))

CEC.RMSE <- ggplot(a[a$variable=="RMSE",], aes(x = model, y = value, fill = value)) +
  geom_col( show.legend = F) +
  facet_grid(hor ~ variable, ) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1), strip.text.y = element_blank()) +
  scale_fill_gradient2(low="#4885ed", mid = "#888888",  high="#db3236" ) + 
  scale_x_discrete(name="") + scale_y_continuous(name = "", limits = c(0,8))

CEC.AVE <- ggplot(a[a$variable=="AVE",], aes(x = model, y = value, fill = value)) +
  geom_col( show.legend = F) +
  facet_grid(hor ~ variable, ) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_fill_gradient2(low="#4885ed", mid = "#888888",  high="#db3236" ) + 
  scale_x_discrete(name="") + scale_y_continuous(name = "", limits = c(-0.3,1))

a <- b
a <- a[a$sp=="OC",]
OC.ME <- ggplot(a[a$variable=="ME",], aes(x = model, y = value, fill = value)) +
  geom_col( show.legend = F) + 
  facet_grid(hor ~ variable) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1), strip.text.y = element_blank()) +
  scale_fill_gradient2(low="#4885ed", mid = "#888888",  high="#db3236" ) + 
  scale_x_discrete(name="") + scale_y_continuous(name = "OC", limits = c(-0.3,0.3))

OC.RMSE <- ggplot(a[a$variable=="RMSE",], aes(x = model, y = value, fill = value)) +
  geom_col( show.legend = F) +
  facet_grid(hor ~ variable, ) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1), strip.text.y = element_blank()) +
  scale_fill_gradient2(low="#4885ed", mid = "#888888",  high="#db3236" ) + 
  scale_x_discrete(name="") + scale_y_continuous(name = "", limits = c(0,0.8))

OC.AVE <- ggplot(a[a$variable=="AVE",], aes(x = model, y = value, fill = value)) +
  geom_col( show.legend = F) +
  facet_grid(hor ~ variable, ) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_fill_gradient2(low="#4885ed", mid = "#888888",  high="#db3236" ) + 
  scale_x_discrete(name="") + scale_y_continuous(name = "", limits = c(-0.3,1))

a <- b
a <- a[a$sp=="Clay",]
clay.ME <- ggplot(a[a$variable=="ME",], aes(x = model, y = value, fill = value)) +
  geom_col( show.legend = F) + 
  facet_grid(hor ~ variable) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1), strip.text.y = element_blank()) +
  scale_fill_gradient2(low="#4885ed", mid = "#888888",  high="#db3236" ) + 
  scale_x_discrete(name="") + scale_y_continuous(name = "Clay", limits = c(-5,5))

clay.RMSE <- ggplot(a[a$variable=="RMSE",], aes(x = model, y = value, fill = value)) +
  geom_col( show.legend = F) +
  facet_grid(hor ~ variable, ) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1), strip.text.y = element_blank()) +
  scale_fill_gradient2(low="#4885ed", mid = "#888888",  high="#db3236" ) + 
  scale_x_discrete(name="") + scale_y_continuous(name = "", limits = c(0,12))

clay.AVE <- ggplot(a[a$variable=="AVE",], aes(x = model, y = value, fill = value)) +
  geom_col( show.legend = F) +
  facet_grid(hor ~ variable, ) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_fill_gradient2(low="#4885ed", mid = "#888888",  high="#db3236" ) + 
  scale_x_discrete(name="") + scale_y_continuous(name = "", limits = c(-0.3,1))

grid.arrange(CEC.ME, CEC.RMSE, CEC.AVE,
             OC.ME, OC.RMSE, OC.AVE,
             clay.ME, clay.RMSE, clay.AVE,
             ncol=3, nrow=3)




# library(lattice)
# par(mfrow = c(3, 1), pty = "s")
# plot1 <- barchart(ME ~ model | sp*hor,  between = list(x = 0.5, y = 0),
#          data=a, origin = 0, scales=list(x=list(rot=90))) 
# plot2 <- barchart(RMSE ~ model | sp+hor,  between = list(x = 0.5, y = 0),
#          data=a, origin = 0, scales=list(x=list(rot=90)))
# plot3 <- barchart(AVE ~ model | sp+hor,  between = list(x = 0.5, y = 0),
#          data=a, origin = 0, scales=list(x=list(rot=90)),)
# 
# 
# print(plot1, position=c(0,.66,1,1), more=T)
# print(plot2, position=c(0,.33,1,0.66), more=T)
# print(plot3, position=c(0,0,1,0.33), more=F)
```

